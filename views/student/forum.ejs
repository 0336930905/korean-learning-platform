<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diễn đàn thảo luận | Korean Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .floating-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        .slide-in {
            animation: slideIn 0.6s ease-out forwards;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .forum-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            margin-bottom: 32px;
        }
        
        .forum-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .post-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            transition: all 0.4s ease;
            margin-bottom: 24px;
        }
        
        .post-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .post-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15);
        }
        
        .post-header {
            padding: 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .post-title {
            font-size: 24px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 12px;
            line-height: 1.3;
        }
        
        .post-content {
            padding: 0 24px 16px;
            color: #6b7280;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .post-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .post-card:hover .post-actions {
            opacity: 1;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .action-btn.edit {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
        }
        
        .action-btn.delete {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .author-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }
        
        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .author-details {
            flex: 1;
        }
        
        .author-name {
            font-weight: 600;
            color: #374151;
        }
        
        .post-date {
            font-size: 14px;
            color: #6b7280;
        }
        
        .image-gallery {
            padding: 0 24px 16px;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .image-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            aspect-ratio: 16/9;
        }
        
        .image-item:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent, rgba(0, 0, 0, 0.3));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-item:hover .image-overlay {
            opacity: 1;
        }
        
        .comments-section {
            border-top: 2px solid rgba(0, 0, 0, 0.05);
            padding: 24px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02), rgba(118, 75, 162, 0.02));
        }
        
        .comments-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .comments-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #10b981, #34d399);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
        
        .comments-title {
            font-weight: 600;
            color: #374151;
        }
        
        .comment-item {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .comment-item:hover {
            transform: translateX(8px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .comment-content {
            margin-bottom: 8px;
            color: #374151;
            line-height: 1.5;
        }
        
        .comment-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-author {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .comment-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .comment-item:hover .comment-actions {
            opacity: 1;
        }
        
        .comment-form {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            margin-top: 16px;
        }
        
        .comment-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 12px;
            border-radius: 12px;
            outline: none;
            font-size: 14px;
            color: #374151;
        }
        
        .comment-input:focus {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .btn-3d {
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.3s ease;
            overflow: hidden;
            border: none;
            cursor: pointer;
        }
        
        .btn-3d::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.4s ease;
            transform: translate(-50%, -50%);
        }
        
        .btn-3d:hover::before {
            width: 200%;
            height: 200%;
        }
        
        .btn-3d:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            color: white;
            text-decoration: none;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-success:hover {
            color: white;
            text-decoration: none;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary {
            background: rgba(107, 114, 128, 0.1);
            color: #374151;
            border: 2px solid rgba(107, 114, 128, 0.2);
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(107, 114, 128, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.2);
            text-decoration: none;
            color: #374151;
        }
        
        .btn-send {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .btn-send:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }
        
        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            padding: 32px 32px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 28px;
            font-weight: 700;
            color: #374151;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(107, 114, 128, 0.1);
            border: none;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 32px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(107, 114, 128, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
            background: white;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .file-input {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 24px;
            border: 2px dashed rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input:hover .file-input-label {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .file-hint {
            margin-top: 8px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            padding: 0 32px 32px;
        }
        
        .image-modal {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .image-modal .modal-content {
            background: transparent;
            border: none;
            box-shadow: none;
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .image-modal img {
            width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .image-modal .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            z-index: 10;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 25px;
            border: 2px dashed rgba(102, 126, 234, 0.2);
        }
        
        .empty-icon {
            font-size: 80px;
            color: #d1d5db;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #34d399);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #f87171);
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        @media (max-width: 768px) {
            .header-icon {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .post-card,
            .forum-header {
                margin: 16px;
                border-radius: 20px;
            }
            
            .post-header,
            .post-content,
            .comments-section {
                padding: 16px;
            }
            
            .modal-content {
                width: 95%;
                margin: 16px;
            }
            
            .modal-header,
            .modal-body,
            .modal-actions {
                padding: 20px;
            }
            
            .image-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen">
    <div class="flex h-screen">
        <!-- Include Student Sidebar -->
        <%- include('../partials/student_sidebar', { 
            user: locals.user, 
            path: '/student/forum' 
        }) %>

        <div class="flex-1 flex flex-col overflow-hidden">
            <%- include('../partials/dashboards_header') %>

            <main class="flex-1 overflow-x-hidden overflow-y-auto">
                <div class="container mx-auto px-4 py-8">
                    <!-- Hero Section -->
                    <div class="text-center mb-8 slide-in">
                        <div class="header-icon floating-animation mx-auto">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h1 class="text-5xl font-bold gradient-text mb-4">Diễn đàn thảo luận</h1>
                        <p class="text-xl text-gray-600">Chia sẻ kiến thức và kết nối với cộng đồng học tập</p>
                    </div>

                    <!-- Forum Header -->
                    <div class="forum-header slide-in fade-in">
                        <div class="p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                <div class="flex-1">
                                    <h2 class="text-3xl font-bold gradient-text mb-4">
                                        <i class="fas fa-fire mr-3 text-orange-500"></i>
                                        Thảo luận sôi nổi
                                    </h2>
                                    <p class="text-gray-600 text-lg">
                                        Tham gia thảo luận với bạn bè và giảng viên về các chủ đề học tập
                                    </p>
                                    <div class="flex items-center space-x-6 mt-4 text-sm text-gray-500">
                                        <div class="flex items-center">
                                            <i class="fas fa-users mr-2 text-blue-500"></i>
                                            <span><%= posts.length %> bài viết</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-comments mr-2 text-green-500"></i>
                                            <span><%= posts.reduce((total, post) => total + post.comments.length, 0) %> bình luận</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-clock mr-2 text-purple-500"></i>
                                            <span>Hoạt động hàng ngày</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-6 md:mt-0">
                                    <button onclick="openNewPostModal()" 
                                            class="btn-primary btn-3d">
                                        <i class="fas fa-plus mr-2"></i>
                                        Tạo bài viết mới
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Posts List -->
                    <% if (posts.length === 0) { %>
                        <div class="empty-state slide-in fade-in">
                            <div class="empty-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-gray-600 mb-4">Chưa có bài viết nào</h3>
                            <p class="text-xl text-gray-500 mb-8">
                                Hãy là người đầu tiên chia sẻ suy nghĩ của bạn trong diễn đàn!
                            </p>
                            <button onclick="openNewPostModal()" class="btn-primary btn-3d">
                                <i class="fas fa-plus mr-2"></i>
                                Tạo bài viết đầu tiên
                            </button>
                        </div>
                    <% } else { %>
                        <div class="space-y-8">
                            <% posts.forEach((post, index) => { %>
                                <div class="post-card slide-in fade-in card-hover" 
                                     style="animation-delay: <%= index * 0.1 %>s;">
                                    
                                    <!-- Post Header -->
                                    <div class="post-header">
                                        <div class="flex justify-between items-start">
                                            <h2 class="post-title">
                                                <%= post.title %>
                                            </h2>
                                            
                                            <!-- Post Actions -->
                                            <% if (user._id.toString() === post.author._id.toString()) { %>
                                                <div class="post-actions">
                                                    <button onclick="openEditPostModal('<%= post._id %>', '<%= post.title %>', '<%= post.content.replace(/'/g, '\\\'') %>')" 
                                                            class="action-btn edit" 
                                                            title="Chỉnh sửa">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="confirmDeletePost('<%= post._id %>')" 
                                                            class="action-btn delete"
                                                            title="Xóa">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            <% } %>
                                        </div>

                                        <!-- Author Info -->
                                        <div class="author-info">
                                            <div class="author-avatar">
                                                <%= post.author.fullName.charAt(0).toUpperCase() %>
                                            </div>
                                            <div class="author-details">
                                                <div class="author-name">
                                                    <%= post.author.fullName %>
                                                </div>
                                                <div class="post-date">
                                                    <i class="fas fa-clock mr-1"></i>
                                                    <%= new Date(post.createdAt).toLocaleString('vi-VN', {
                                                        year: 'numeric',
                                                        month: 'long', 
                                                        day: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    }) %>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Post Content -->
                                    <div class="post-content">
                                        <p><%= post.content %></p>
                                    </div>

                                    <!-- Image Gallery -->
                                    <% if (post.images && post.images.length > 0) { %>
                                        <div class="image-gallery">
                                            <div class="image-grid">
                                                <% post.images.forEach(image => { %>
                                                    <div class="image-item" onclick="openImageModal('<%= image.filename %>')">
                                                        <img 
                                                            src="/uploads/forum/<%= image.filename %>" 
                                                            alt="<%= image.originalname %>"
                                                            onerror="this.onerror=null; this.src='/images/default-image.png';"
                                                        />
                                                        <div class="image-overlay"></div>
                                                    </div>
                                                <% }) %>
                                            </div>
                                        </div>
                                    <% } %>

                                    <!-- Comments Section -->
                                    <div class="comments-section">
                                        <div class="comments-header">
                                            <div class="comments-icon">
                                                <i class="fas fa-comments"></i>
                                            </div>
                                            <div class="comments-title">
                                                Bình luận (<%= post.comments.length %>)
                                            </div>
                                        </div>
                                        
                                        <!-- Existing Comments -->
                                        <% if (post.comments.length > 0) { %>
                                            <div class="space-y-3 mb-6">
                                                <% post.comments.forEach(comment => { %>
                                                    <div class="comment-item">
                                                        <div class="comment-content">
                                                            <%= comment.content %>
                                                        </div>
                                                        <div class="comment-meta">
                                                            <div class="comment-author">
                                                                <i class="fas fa-user mr-1"></i>
                                                                <%= comment.author.fullName %> • 
                                                                <%= new Date(comment.createdAt).toLocaleDateString('vi-VN') %>
                                                            </div>
                                                            
                                                            <!-- Comment Actions -->
                                                            <% if (user._id.toString() === comment.author._id.toString()) { %>
                                                                <div class="comment-actions">
                                                                    <button onclick="openEditCommentModal('<%= post._id %>', '<%= comment._id %>', '<%= comment.content.replace(/'/g, '\\\'') %>')"
                                                                            class="action-btn edit"
                                                                            title="Chỉnh sửa">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    <button onclick="confirmDeleteComment('<%= post._id %>', '<%= comment._id %>')"
                                                                            class="action-btn delete"
                                                                            title="Xóa">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </div>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                <% }) %>
                                            </div>
                                        <% } %>

                                        <!-- Comment Form -->
                                        <form action="/student/forum/comment/<%= post._id %>" method="POST" class="comment-form">
                                            <input type="text" 
                                                   name="content" 
                                                   required
                                                   placeholder="Thêm bình luận của bạn..." 
                                                   class="comment-input">
                                            <button type="submit" class="btn-send btn-3d">
                                                <i class="fas fa-paper-plane mr-1"></i>
                                                Gửi
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } %>
                </div>
            </main>
        </div>
    </div>

    <!-- New Post Modal -->
    <div id="newPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Tạo bài viết mới</h2>
                <button type="button" onclick="closeNewPostModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form action="/student/forum/post" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="title" class="form-label">
                            <i class="fas fa-heading mr-2 text-blue-500"></i>
                            Tiêu đề bài viết
                        </label>
                        <input type="text" id="title" name="title" required class="form-input" 
                               placeholder="Nhập tiêu đề thu hút...">
                    </div>
                    
                    <div class="form-group">
                        <label for="content" class="form-label">
                            <i class="fas fa-pen mr-2 text-green-500"></i>
                            Nội dung
                        </label>
                        <textarea id="content" name="content" required class="form-textarea" 
                                  placeholder="Chia sẻ suy nghĩ của bạn..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="classId" class="form-label">
                            <i class="fas fa-users mr-2 text-purple-500"></i>
                            Chọn lớp học
                        </label>
                        <select id="classId" name="classId" required class="form-select">
                            <option value="">-- Chọn lớp học --</option>
                            <% classes.forEach(classItem => { %>
                                <option value="<%= classItem._id %>">
                                    <%= classItem.name %> - <%= classItem.course.title %>
                                </option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-images mr-2 text-orange-500"></i>
                            Hình ảnh (tối đa 5 ảnh)
                        </label>
                        <div class="file-input">
                            <input type="file" name="images" multiple accept="image/*" id="imageUpload">
                            <div class="file-input-label">
                                <i class="fas fa-cloud-upload-alt text-2xl"></i>
                                <span>Nhấn để chọn ảnh hoặc kéo thả vào đây</span>
                            </div>
                        </div>
                        <div class="file-hint">
                            PNG, JPG, GIF tối đa 5MB mỗi ảnh
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" onclick="closeNewPostModal()" class="btn-secondary">
                        Hủy bỏ
                    </button>
                    <button type="submit" class="btn-primary btn-3d">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Đăng bài
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Chỉnh sửa bài viết</h2>
                <button type="button" onclick="closeEditPostModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editPostForm" method="POST">
                <input type="hidden" name="_method" value="PUT">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-heading mr-2 text-blue-500"></i>
                            Tiêu đề
                        </label>
                        <input type="text" name="title" id="editTitle" required class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-pen mr-2 text-green-500"></i>
                            Nội dung
                        </label>
                        <textarea name="content" id="editContent" required class="form-textarea"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeEditPostModal()" class="btn-secondary">
                        Hủy bỏ
                    </button>
                    <button type="submit" class="btn-success btn-3d">
                        <i class="fas fa-save mr-2"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Comment Modal -->
    <div id="editCommentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Chỉnh sửa bình luận</h2>
                <button type="button" onclick="closeEditCommentModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editCommentForm" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editCommentContent" class="form-label">
                            <i class="fas fa-comment mr-2 text-blue-500"></i>
                            Nội dung bình luận
                        </label>
                        <textarea id="editCommentContent" name="content" required class="form-textarea"></textarea>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeEditCommentModal()" class="btn-secondary">
                        Hủy bỏ
                    </button>
                    <button type="submit" class="btn-success btn-3d">
                        <i class="fas fa-save mr-2"></i>
                        Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal image-modal">
        <div class="modal-content">
            <button onclick="closeImageModal()" class="modal-close">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <img id="modalImage" src="" alt="Enlarged image">
        </div>
    </div>

    <script>
        // Modal Functions
        function openNewPostModal() {
            const modal = document.getElementById('newPostModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeNewPostModal() {
            const modal = document.getElementById('newPostModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function openEditPostModal(postId, title, content) {
            const modal = document.getElementById('editPostModal');
            const form = document.getElementById('editPostForm');
            form.action = `/student/forum/post/${postId}`;
            document.getElementById('editTitle').value = title;
            document.getElementById('editContent').value = content;
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeEditPostModal() {
            const modal = document.getElementById('editPostModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function openEditCommentModal(postId, commentId, content) {
            const modal = document.getElementById('editCommentModal');
            const form = document.getElementById('editCommentForm');
            const contentInput = document.getElementById('editCommentContent');
            
            form.action = `/student/forum/comment/${postId}/${commentId}`;
            contentInput.value = content;
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeEditCommentModal() {
            const modal = document.getElementById('editCommentModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function openImageModal(filename) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = `/uploads/forum/${filename}`;
            modalImage.onerror = function() {
                this.onerror = null;
                this.src = '/images/default-image.png';
            };
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Delete Functions
        function confirmDeletePost(postId) {
            if (confirm('Bạn có chắc chắn muốn xóa bài viết này? Hành động này không thể hoàn tác.')) {
                showNotification('Đang xóa bài viết...', 'info');
                fetch(`/student/forum/post/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        showNotification('Đã xóa bài viết thành công!', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showNotification('Có lỗi xảy ra khi xóa bài viết', 'error');
                    }
                }).catch(error => {
                    showNotification('Có lỗi xảy ra khi xóa bài viết', 'error');
                });
            }
        }

        function confirmDeleteComment(postId, commentId) {
            if (confirm('Bạn có chắc chắn muốn xóa bình luận này?')) {
                showNotification('Đang xóa bình luận...', 'info');
                fetch(`/student/forum/comment/${postId}/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    if (response.ok) {
                        showNotification('Đã xóa bình luận thành công!', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        showNotification('Có lỗi xảy ra khi xóa bình luận', 'error');
                    }
                }).catch(error => {
                    showNotification('Có lỗi xảy ra khi xóa bình luận', 'error');
                });
            }
        }

        // Notification function
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                   type === 'error' ? 'fa-exclamation-circle' : 
                                   'fa-info-circle'} text-xl mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            });
        });

        // Keyboard support (ESC key to close)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
                document.body.style.overflow = 'auto';
            }
        });

        // File upload preview
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = e.target.files;
            const label = document.querySelector('.file-input-label span');
            
            if (files.length > 0) {
                const fileNames = Array.from(files).map(file => file.name).join(', ');
                label.textContent = `Đã chọn ${files.length} ảnh: ${fileNames.substring(0, 50)}${fileNames.length > 50 ? '...' : ''}`;
            } else {
                label.textContent = 'Nhấn để chọn ảnh hoặc kéo thả vào đây';
            }
        });

        // Initialize animations on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add staggered animations
            const elements = document.querySelectorAll('.slide-in');
            elements.forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
            });

            // Lazy loading for images
            const images = document.querySelectorAll('img');
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                        }
                        imageObserver.unobserve(img);
                    }
                });
            });

            images.forEach(img => {
                if (img.dataset.src) {
                    imageObserver.observe(img);
                }
            });

            // Add intersection observer for scroll animations
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });
        });
    </script>

    <%- include('../partials/student_footer') %>
</body>
</html>